# Virus Host Association Pipeline

This script (`host_associator.py`) is designed to predict the hosts of viral operational taxonomic units (vOTUs) by integrating taxonomic annotations from multiple bioinformatics tools and cross-referencing them with the official International Committee on Taxonomy of Viruses (ICTV) database.

## Synopsis

The script takes taxonomic assignments for a set of vOTUs from various sources (geNomad, palmdb, a custom plant virus database, and MMseqs2) and compares them against a curated virus-host database from ICTV. It determines a consensus host prediction by finding the most specific taxonomic level (species, genus, or family) at which a reliable host can be assigned. The final output is a comprehensive table detailing the host predictions for each vOTU.

## How It Works

The script follows a multi-step process to assign hosts:

1.  **Data Ingestion**: It reads three main input files:
    *   A general annotation file with vOTU IDs and taxonomy from geNomad, palmdb, and a plant virus database.
    *   A taxonomy file generated by `mmseqs easy-taxonomy`.
    *   An Excel file containing the ICTV virus taxonomy and their known host ranges.

2.  **ICTV and MMseqs Integration**:
    *   The script first parses the ICTV database to create a mapping from viral taxa (family, genus, and species) to their known hosts.
    *   It then processes the `mmseqs` output, using the provided NCBI taxonomy IDs to fetch the complete taxonomic lineage for each vOTU.
    *   This enriched `mmseqs` data is then combined with the ICTV host information, annotating each vOTU with potential hosts based on its taxonomic classification.

3.  **Consolidation of Annotations**:
    *   The script merges the taxonomic data from all sources (geNomad, palmdb, etc.) with the enriched `mmseqs` data into a single, comprehensive data structure.

4.  **Consensus Host Prediction**:
    *   For each vOTU, the script evaluates the taxonomic assignments from every tool.
    *   It queries the ICTV host data using the taxonomy provided by each tool at the species, genus, and family levels.
    *   A hierarchical approach is used to determine the "best" host prediction:
        *   **Species-level** matches are prioritized.
        *   If no species-level match is found, **genus-level** matches are considered.
        *   If neither are available, **family-level** matches are used.
    *   The script identifies which tool(s) support the host assignment at the highest possible resolution. If different tools suggest conflicting hosts at the same taxonomic level, this is flagged.

5.  **Output Generation**:
    *   The script produces several output files, with the primary one being `host_association_ictv.tsv`. This file contains the final host predictions and supporting evidence.
    *   A second file, `plant_host_association_ictv.tsv`, is also created, containing a subset of the results for vOTUs predicted to infect plants.

## Dependencies

The script requires the following Python libraries:

*   `pandas`
*   `ete3`
*   `numpy`
*   `openpyxl` (for reading `.xlsx` files with pandas)

You can install them using pip:
```bash
pip install pandas ete3 numpy openpyxl
```
The `ete3` library also requires setting up the NCBI taxonomy database locally. The first time you run the script, it may prompt you to do this.

## Usage

Run the script from the command line, providing the paths to the three required input files.

```bash
python host_associator.py <annotation_file.tsv> <mmseqs_taxonomy.tsv> <ictv_database.xlsx>
```

### Input Files

1.  **`<annotation_file.tsv>`**: A tab-separated file containing annotations for your vOTUs. The script expects specific columns for vOTU ID, geNomad taxonomy, palmdb taxonomy, and plant virus database taxonomy.

2.  **`<mmseqs_taxonomy.tsv>`**: The standard output file from a `mmseqs easy-taxonomy` run.

3.  **`<ictv_database.xlsx>`**: An Excel file containing the official ICTV virus master species list, which must include columns for virus taxonomy (Family, Genus, Species) and their associated hosts (`Host source`).

### Output Files

*   `host_association_ictv.tsv`: The main output file. A comprehensive TSV containing each vOTU, its taxonomic information from all tools, and the final host prediction with details on how it was derived.
*   `plant_host_association_ictv.tsv`: A filtered version of the main output, including only vOTUs associated with plant hosts.
*   `mmseqs_ictv_merged.tsv` and `mmseqs_ictv_host_association.tsv`: Intermediate files generated during the process.
